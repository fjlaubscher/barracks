name: CI

on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VITE_WORKER_URL: ${{secrets.WORKER_URL}}
      VITE_OAUTH_CLIENT_ID: ${{secrets.OAUTH_CLIENT_ID}}
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    - run: sudo apt-get install rsync
    - run: echo -e "VITE_WORKER_URL=$WORKER_URL\r\nVITE_OAUTH_CLIENT_ID=$OAUTH_CLIENT_ID" > .env
    - run: npm install -g yarn
    - run: yarn install
    - run: yarn build
    - name: rsync-deploy
      uses: Pendect/action-rsyncer@v2.0.0
      env:
        DEPLOY_KEY: ${{secrets.DEPLOY_KEY}}
      with:
        flags: '-arv --delete'
        src: 'barracks-web/dist/'
        dest: 'root@"${{secrets.SERVER_IP}}":/var/www/barracks'
